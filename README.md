# container-vulnerability-exporter

The container vulnerability exporter will collect an image inventory from an OpenShift cluster and report on vulnerabilities within those images, providing the resulting data as metrics.

The code here is currently in a development/proof-of-concept/discovery state. The results of this work will be developed into an operator for simplified deployment/management. This code is developed for and tested with OpenShift =>3.11 ([k8s 1.11](https://github.com/openshift/origin/tree/release-3.11/vendor/k8s.io)), but may also work with non-OpenShift k8s clusters.  

## Quickstart

- Clone this repo
- Have an active/authenticated k8s config
- pip install openshift prometheus_client
- ./cluster-cvscanner.py (^C to exit)
- Point prom scraper at localhost:8080/metrics
- Enjoy!

## Single-purpose utilities
### Image Inventory
[get-poddata.py](getpoddata.py) will produce a list of container images, including their source and identifying hash for a cluster
- Requires [OpenShift python client](https://pypi.org/project/openshift/), (developed and tested with =0.9.2)
  - "pip install openshift" will install this dependency
- Dynamic k8s api client will detect instantiated k8s client via KUBECONFIG env var or default kube config file path (~/.kube/config)
- Env var SKIPNS is a list of namespaces to ignore
- Env var TARGETNS is a list of namespaces to look for images in; namespaces defined in SKIPNS will be excluded
- If TARGETNS is not set, all discoverable namespaces are scanned and namespaces defined in SKIPNS will be excluded
- Currently, will filter image+hash data output for only quay.io hosted images

Data Sample
```
Ignoring namespaces:
  ['dedicated-admin', 'dedicated-reader', 'default', 'kube-public', 'kube-system', 'management-infra', 'openshift']

Images by source:
  quay.io: 5
  docker.io: 1
  docker-registry.default.svc:5000: 1

quay.io/foo-org/bar-image,sha256:50d858e0985ecc7f60418aaf0cc5ab587f42c2570a884095a9e8ccacd0f6545c
```
### Vulnerability Data Extract
[get-quayvulndata.py](get-quayvulndata.py) will produce a count of low/medium/high rated [CVEs](https://cve.mitre.org/) for each image it processes.  

* Currently data is sourced for images hosted with [Quay.io](https://quay.io), which makes use of [Clair](https://github.com/coreos/clair)  
* Looks for QUAY_TOKEN env var, in order to access the Quay.io API
* Images hosted with Quay.io may be in several active states: scanned, scanning, unscanned/not-supported  

Data Sample
```
quay.io/foo-org/bar-image (sha256:50d858e0985ecc7f60418aaf0cc5ab587f42c2570a884095a9e8ccacd0f6545c) {'high': 10, 'medium': 1, 'low': 4}
```

### Metric Generator
[vulndata-export.py](vulndata-export.py) is a metric exporter for container image and vulnerability data.  

- Requires [Prometheus python client](https://github.com/prometheus/client_python), (developed and tested with 0.7.1)
  - "pip install prometheus_client"
- Metrics are made available as a [Prometheus Exporter](https://prometheus.io/docs/instrumenting/exporters/)
- [Example instrumentation](https://sysdig.com/blog/prometheus-metrics/#pythoncodeinstrumentationwithprometheusmetricsopenmetrics)
- Port is defined by env var LISTEN_PORT, undefined will default to port tcp/8080
- URI is defined by env var SCRAPE_PATH, undefined will default to uri "/metrics"

# Unified Script: Cluster Scanner
All of the above individual functions are merged into a single looping script, [cluster-cvscanner.py](cluster-cvscanner.py).

## Dependencies
- [OpenShift python client](https://pypi.org/project/openshift/), (=>0.9.2), "pip install openshift"
- [Prometheus python client](https://github.com/prometheus/client_python), (=>0.7.1), "pip install prometheus_client"

## Configuration
- (env) KUBECONFIG {optional}: path to k8s config file; default: "~/.kube/config"
- (env) SKIPNS {optional}, list of namespaces to skip when collecting image data from a cluster; default: "" -- no namespaces will be filtered
- (env) TARGETNS {optional}, list of namespaces to scan for image data from a cluster; default: "" -- all available namespaces will be scanned
- (env)

## Features
- Reports CVE data produced by [Quay.io](https://quay.io) (via Clair)
- Code syntax validated with [flake8](https://pypi.org/project/flake8/)
- Results from API are cached with no external dependency (via [lrucache](https://docs.python.org/3/library/functools.html#functools.lru_cache))
- Metrics provided as a Prometheus export, work with anything that can scrape a Prometheus endpoint


# TODO / Backlog
## Milestone_0
- [ ] PoC: Get images, get vuln data, output as prom-exporter metrics
  - [x] Image gather
  - [x] Vuln data gather
  - [ ] Prom exporter
  - [ ] Unified script
    - [x] cache
    - [x] lint check
## Milestone_1
- [ ] tests
- [ ] Skip/Include pods by label
- [ ] Skip system namespaces automatically
- [ ] Metric export, non-quay.io images
- [ ] Metric export, introspection: api calls made (to openshift, to quay), success|failure count, latency of api calls
- [ ] Saasherder integration files (service definition, jjb)
## Milestone_2
- [ ] Controller/Operator-ize -- go-lang..?
## Milestone_3
- [ ] Non-quay image CVE data?
