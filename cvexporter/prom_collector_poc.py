import time
import random
import logging
import os


from functools import lru_cache as lc


from prometheus_client.core import REGISTRY, GaugeMetricFamily
from prometheus_client import start_http_server


class CustomCollector(object):
    def collect(self):
        g = GaugeMetricFamily('foo_total',
                              'Foo Totals by Severity',
                              labels=['namespace',
                                      'severity'])
        raw_data = prom_cache()
        for ns, sev, val in raw_data:
            g.add_metric([ns, sev], val)
        yield g


@lc()
def get_real_values():
    data = []
    for rn in range(1, random.randint(1, 10)):
        data.append(('foo'+str(rn), 'low', random.randint(1, 10)))
    logging.info('New data is in the cache: {}'.format(str(data)))
    return data


@lc()
def prom_cache():
    return get_real_values()


if __name__ == '__main__':
    os.environ['TZ'] = 'UTC'
    time.tzset()
    level = logging.INFO
    logging.basicConfig(format='%(asctime)s - %(message)s', level=level)
    logging.info('Seed initial front+back cache before we start prom loop.')
    start_http_server(8000)
    REGISTRY.register(CustomCollector())
    prom_cache()
    while True:
        logging.info('Purge back-end cache')
        get_real_values.cache_clear()
        logging.info('Update back-end cache')
        get_real_values()
        logging.info('Clear front-end (prom) cache')
        prom_cache.cache_clear()
        logging.info('Update front-end (prom) cache')
        prom_cache()
        time.sleep(10)
