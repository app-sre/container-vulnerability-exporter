#!/usr/bin/env python

import os, requests, json

QUAY_TOKEN = os.environ['QUAY_TOKEN']
API = 'https://quay.io/api/v1/'

# rest call:
#   https://quay.io/api/v1/repository/app-sre/nginx-gate/manifest/sha256:645880598e983709155dd9ea8572b7d070f9832ce24f136c737d65b5cc7293b9/security?vulnerabilities=true
# /api/v1/ repository/ {repository}/ manifest/ {manifestref}/ security 
# browser url:
#   https://quay.io/repository/app-sre/nginx-gate/manifest/sha256:645880598e983709155dd9ea8572b7d070f9832ce24f136c737d65b5cc7293b9?tab=vulnerabilities

org="app-sre"
name="nginx-gate"
hash="sha256%3A645880598e983709155dd9ea8572b7d070f9832ce24f136c737d65b5cc7293b9"
#tag="89fffba"
#id="4a88515d2b9053ea9e7a235aa55226baad6c86f3a1025a2a31e31f2112270010"
url = str("%srepository/%s/%s/manifest/%s/security" % (API, org, name, hash))
headers = {'Authorization': 'Bearer {}'.format(QUAY_TOKEN)}
params = {
    'vulnerabilities': 'true'
}

class VulnStats:
  totals = {}
  def __init__(self):
    self.totals["high"] = 0
    self.totals["medium"] = 0
    self.totals["low"] = 0

r = requests.get(url, headers=headers, params=params)

vulndata = r.json()
packages = vulndata["data"]["Layer"]["Features"]
vulnstats = VulnStats()

for package in packages:
  if "Vulnerabilities" in package:
    for vuln in package["Vulnerabilities"]:
      vulnstats.totals[str(vuln["Severity"]).lower()] += 1

print("quay.io/%s/%s (%s) vulnerabilities: %s" % (org, name, hash, vulnstats.totals))
